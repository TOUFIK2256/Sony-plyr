<!-- START OF FILE SPTV_Admin_Card_View.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPTV Admin - Match Cards</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-dark: #000000;
            --card-bg: #101010;
            --card-border: #333;
            --header-bg: #1a1a1a;
            --text-yellow: #f1c40f;
            --text-white: #ffffff;
            --text-gray: #b0b0b0;
            --highlight: #00e5ff;
            --btn-orange: #ff6b00;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-white);
            margin: 0;
            padding-bottom: 80px;
            font-size: 12px;
        }

        /* HEADER (FIXED) */
        .header {
            background-color: #050505;
            padding: 10px;
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 2px solid var(--highlight);
            box-shadow: 0 4px 10px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; gap: 8px;
        }
        
        #matchSelector {
            background: #222; color: #fff; border: 1px solid #444;
            padding: 10px; border-radius: 4px; font-weight: bold; font-size: 12px;
            width: 100%; outline: none;
        }
        
        .add-btn {
            background: var(--btn-orange); color: #000; border: none; padding: 10px;
            border-radius: 4px; font-weight: 800; font-size: 12px; cursor: pointer;
            width: 100%; text-transform: uppercase;
        }

        /* MAIN CONTAINER */
        .container {
            padding: 15px 10px;
            max-width: 800px;
            margin: 0 auto;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* MATCH CARD DESIGN */
        .match-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .card-header {
            background: var(--header-bg);
            padding: 10px;
            border-bottom: 1px solid var(--card-border);
            display: flex; align-items: center;
        }

        .league-logo {
            width: 35px; height: 35px; border-radius: 50%;
            background: #fff; padding: 2px; margin-right: 10px;
        }

        .match-info h3 { margin: 0; font-size: 14px; color: var(--text-white); }
        .match-info span { font-size: 11px; color: var(--text-gray); }

        /* STREAM LIST INSIDE CARD */
        .stream-list { padding: 5px; }

        .stream-row {
            display: flex; align-items: center; gap: 6px;
            background: #000;
            border: 1px solid #222;
            padding: 6px; margin-bottom: 5px;
            border-radius: 4px;
            transition: 0.2s;
        }
        
        /* Highlight selected stream row */
        .stream-row.selected {
            border-color: var(--highlight);
            background: #0a2a2e;
        }

        .pos-select {
            background: #111; color: var(--text-yellow); border: 1px solid #333;
            width: 45px; height: 30px; border-radius: 4px;
            text-align: center; font-weight: bold; font-size: 12px;
        }

        .stream-name {
            flex-grow: 1; font-size: 12px; font-weight: 600; color: var(--highlight);
            padding-left: 5px;
        }

        /* BUTTONS */
        .btn-group { display: flex; gap: 4px; }

        .btn-opt {
            background: #252525; color: #aaa; border: 1px solid #444;
            padding: 4px 8px; border-radius: 3px; font-size: 10px; font-weight: bold;
            cursor: pointer; min-width: 40px; text-align: center;
        }
        
        .stream-row.selected .btn-opt.active-mode {
            background: var(--highlight); color: #000; border-color: var(--highlight);
        }

        .btn-play {
            background: var(--btn-orange); color: #000; border: none;
            padding: 4px 10px; border-radius: 3px; font-size: 10px; font-weight: bold; cursor: pointer;
        }
        .btn-play.playing { background: red; color: white; }

        /* PLAYER AREA */
        .player-area { width: 100%; background: black; display: none; margin-bottom: 5px; }
        .player-area.show { display: block; }

        #status { text-align: center; margin-top: 10px; color: var(--text-yellow); }
    </style>
</head>
<body>

    <div class="header">
        <select id="matchSelector">
            <option value="">Loading Matches...</option>
        </select>
        <button class="add-btn" id="addBtn">ADD TO DATABASE</button>
    </div>

    <div id="status">Fetching Data...</div>
    <div class="container" id="cardsArea"></div>
    
    <!-- Hidden Toast -->
    <div id="toast" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#fff; color:#000; padding:5px 10px; border-radius:5px; opacity:0; pointer-events:none; transition:0.3s; font-weight:bold;">Copied!</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChAHgjZGsE0YUFuStoiOBH-CI42fT_o-g",
            authDomain: "field-fever-b9791.firebaseapp.com",
            databaseURL: "https://field-fever-b9791-default-rtdb.firebaseio.com",
            projectId: "field-fever-b9791",
            storageBucket: "field-fever-b9791.firebasestorage.app",
            messagingSenderId: "776434439897",
            appId: "1:776434439897:web:ce93099eb6fb4bb9f310c8",
            measurementId: "G-24NJCVZN0P"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const selectedRows = new Map();
        
        const API_URL = "https://a.ftvhd.com/diaries.json";
        const BASE_URL = "https://a.ftvhd.com";

        // --- LOAD DB MATCHES ---
        const matchSelect = document.getElementById('matchSelector');
        onValue(ref(db, 'matches'), (snapshot) => {
            matchSelect.innerHTML = '<option value="">-- SELECT MATCH TO ADD --</option>';
            const matches = snapshot.val();
            if (matches) {
                Object.keys(matches).forEach(key => {
                    const m = matches[key];
                    const name = (m.team1Name && m.team2Name) ? `${m.team1Name} vs ${m.team2Name}` : (m.leagueTitle || "Match");
                    matchSelect.appendChild(new Option(name, key));
                });
            }
        });

        // --- DECODE & RENDER ---
        function decodeLink(iframeUrl) {
            try {
                if (iframeUrl && iframeUrl.includes('r=')) return atob(iframeUrl.split('r=')[1]);
                return null;
            } catch(e) { return null; }
        }

        async function loadSPTV() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                document.getElementById('status').style.display = 'none';
                renderCards(data.data);
            } catch (e) {
                document.getElementById('status').innerText = "Error Loading API";
            }
        }

        function renderCards(items) {
            const container = document.getElementById('cardsArea');
            container.innerHTML = "";

            items.forEach(item => {
                const attr = item.attributes;
                const matchTitle = attr.diary_description;
                const matchTime = `${attr.date_diary} | ${attr.diary_hour}`;
                
                let logoUrl = "https://via.placeholder.com/35";
                if(attr.country?.data?.attributes?.image?.data?.attributes?.url) {
                    logoUrl = BASE_URL + attr.country.data.attributes.image.data.attributes.url;
                }

                // 1. CREATE MATCH CARD
                const card = document.createElement('div');
                card.className = 'match-card';
                card.innerHTML = `
                    <div class="card-header">
                        <img src="${logoUrl}" class="league-logo">
                        <div class="match-info">
                            <h3>${matchTitle}</h3>
                            <span>${matchTime}</span>
                        </div>
                    </div>
                    <div class="stream-list" id="streams-${attr.id}"></div>
                `;
                container.appendChild(card);

                // 2. ADD STREAMS TO THIS CARD
                const streamContainer = card.querySelector(`#streams-${attr.id}`);
                const embeds = attr.embeds?.data || [];

                if(embeds.length === 0) {
                    streamContainer.innerHTML = "<div style='padding:10px;color:#555;'>No Streams Available</div>";
                }

                embeds.forEach(embed => {
                    const sName = embed.attributes.embed_name;
                    const sIframe = embed.attributes.embed_iframe;
                    let finalLink = decodeLink(sIframe);
                    if(!finalLink) finalLink = BASE_URL + sIframe;

                    renderStreamRow(streamContainer, matchTitle, sName, finalLink, logoUrl);
                });
            });
        }

        function renderStreamRow(container, matchName, streamName, link, logo) {
            const rowId = Math.random().toString(36).substr(2, 9);
            const iframeCode = `<iframe src="${link}" style="width:100%;aspect-ratio:16/9;border:none;" allow="autoplay;encrypted-media;picture-in-picture;fullscreen" allowfullscreen></iframe>`;
            
            // Position Options
            let opts = "";
            for(let i=1; i<=30; i++) opts += `<option value="${i}">${i}</option>`;

            const div = document.createElement('div');
            div.innerHTML = `
                <div class="stream-row" id="row-${rowId}">
                    <select class="pos-select" id="pos-${rowId}">${opts}</select>
                    <div class="stream-name" id="name-${rowId}">ðŸ“º ${streamName}</div>
                    
                    <div class="btn-group">
                        <div class="btn-opt" id="opt-link-${rowId}">LINK</div>
                        <div class="btn-opt" id="opt-iframe-${rowId}">IFRAME</div>
                        <button class="btn-play" id="play-${rowId}">PLAY</button>
                    </div>
                </div>
                <div class="player-area" id="player-${rowId}"></div>
            `;
            container.appendChild(div);

            // LOGIC ATTACHMENT
            const rowDiv = div.querySelector(`#row-${rowId}`);
            
            // Data for DB
            rowDiv.dataset.name = `${streamName} - ${matchName}`;
            rowDiv.dataset.link = link;
            rowDiv.dataset.iframe = iframeCode;
            rowDiv.dataset.logo = logo;

            // Click to Select
            div.querySelector(`#name-${rowId}`).onclick = () => toggleSelection(rowId);

            // Copy/Toggle Mode
            div.querySelector(`#opt-link-${rowId}`).onclick = () => handleOptClick(rowId, 'link', link);
            div.querySelector(`#opt-iframe-${rowId}`).onclick = () => handleOptClick(rowId, 'iframe', iframeCode);

            // Play
            const pBtn = div.querySelector(`#play-${rowId}`);
            const pArea = div.querySelector(`#player-${rowId}`);
            pBtn.onclick = () => {
                if(pArea.classList.contains('show')) {
                    pArea.classList.remove('show'); pArea.innerHTML = "";
                    pBtn.innerText = "PLAY"; pBtn.classList.remove('playing');
                } else {
                    pArea.classList.add('show'); pArea.innerHTML = iframeCode;
                    pBtn.innerText = "STOP"; pBtn.classList.add('playing');
                }
            };
        }

        // --- SELECTION LOGIC ---
        function toggleSelection(rowId) {
            const row = document.getElementById(`row-${rowId}`);
            const iframeBtn = document.getElementById(`opt-iframe-${rowId}`);
            
            if(selectedRows.has(rowId)) {
                selectedRows.delete(rowId);
                row.classList.remove('selected');
                iframeBtn.classList.remove('active-mode');
                document.getElementById(`opt-link-${rowId}`).classList.remove('active-mode');
            } else {
                // Default to IFRAME mode for DB
                selectedRows.set(rowId, {
                    name: row.dataset.name,
                    linkData: row.dataset.link,
                    iframeData: row.dataset.iframe,
                    logo: row.dataset.logo,
                    mode: 'iframe'
                });
                row.classList.add('selected');
                iframeBtn.classList.add('active-mode');
            }
        }

        function handleOptClick(rowId, mode, text) {
            if(selectedRows.has(rowId)) {
                const data = selectedRows.get(rowId);
                data.mode = mode;
                selectedRows.set(rowId, data);
                
                document.getElementById(`opt-link-${rowId}`).classList.toggle('active-mode', mode === 'link');
                document.getElementById(`opt-iframe-${rowId}`).classList.toggle('active-mode', mode === 'iframe');
            } else {
                navigator.clipboard.writeText(text);
                const t = document.getElementById('toast');
                t.style.opacity = 1; setTimeout(()=>t.style.opacity=0, 1500);
            }
        }

        // --- ADD TO DB LOGIC ---
        document.getElementById('addBtn').onclick = async () => {
            const mId = matchSelect.value;
            if(!mId) return alert("Select a MATCH first!");
            if(selectedRows.size === 0) return alert("Select at least one stream!");

            const btn = document.getElementById('addBtn');
            btn.innerText = "ADDING...";
            
            const linkRef = ref(db, `matches/${mId}/streamLinks`);
            
            try {
                const snap = await get(linkRef);
                let links = snap.val() || [];
                if(!Array.isArray(links)) links = Object.values(links);

                selectedRows.forEach((d, rId) => {
                    const pos = parseInt(document.getElementById(`pos-${rId}`).value) - 1;
                    const finalLink = (d.mode === 'iframe') ? d.iframeData : d.linkData;
                    
                    const obj = {
                        name: d.name,
                        link: finalLink,
                        logo: d.logo,
                        type: (d.mode === 'iframe') ? 'iframe' : 'direct'
                    };

                    while(links.length < pos) links.push({name:"Empty", link:"#", type:"direct"});
                    links.splice(pos, 0, obj);
                });

                await set(linkRef, links);
                alert("Links Added Successfully!");
                
                // Reset
                btn.innerText = "ADD TO DATABASE";
                selectedRows.clear();
                document.querySelectorAll('.stream-row.selected').forEach(e => {
                    e.classList.remove('selected');
                    e.querySelectorAll('.active-mode').forEach(b => b.classList.remove('active-mode'));
                });

            } catch(e) {
                console.error(e);
                alert("Error adding to DB");
                btn.innerText = "ADD TO DATABASE";
            }
        };

        loadSPTV();
    </script>
</body>
</html>
